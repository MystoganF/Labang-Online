{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Management - Admin</title>
    <link rel="stylesheet" href="{% static 'css/administration/admin_reports.css' %}">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p>{{ user.full_name }}</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="{% url 'administration:admin_dashboard' %}"><i>üìä</i> Dashboard</a></li>
                <li><a href="{% url 'administration:admin_users' %}"><i>üë•</i> Users</a></li>
                <li><a href="{% url 'administration:admin_certificates' %}"><i>üìÑ</i> Certificates</a></li>
                <li><a href="{% url 'administration:admin_reports' %}" class="active"><i>üìã</i> Reports</a></li>
                <li><a href="{% url 'administration:admin_announcements' %}"><i>üì¢</i> Announcements</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="{% url 'accounts:personal_info' %}" class="btn btn-primary"> User View</a>
                <form method="get" action="{% url 'accounts:logout_confirm' %}" class="logout-form">
                    <button type="submit" class="btn-logout">üö™ LOGOUT</button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Incident Report Management</h1>
                <p>Review and manage incident reports from residents</p>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <form method="GET" class="filters-form">
                    <div class="form-group">
                        <label for="q">Search</label>
                        <input type="text" id="q" name="q" placeholder="Report ID, Name, Place..." value="{{ request.GET.q }}">
                    </div>
                    <div class="form-group">
                        <label for="incident_type">Incident Type</label>
                        <select id="incident_type" name="incident_type">
                            <option value="">All Types</option>
                            <option value="Theft" {% if request.GET.incident_type == 'Theft' %}selected{% endif %}>Theft</option>
                            <option value="Assault" {% if request.GET.incident_type == 'Assault' %}selected{% endif %}>Assault</option>
                            <option value="Vandalism" {% if request.GET.incident_type == 'Vandalism' %}selected{% endif %}>Vandalism</option>
                            <option value="Disturbance" {% if request.GET.incident_type == 'Disturbance' %}selected{% endif %}>Disturbance</option>
                            <option value="Other" {% if request.GET.incident_type == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="">All Status</option>
                            <option value="Pending" {% if request.GET.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Under Investigation" {% if request.GET.status == 'Under Investigation' %}selected{% endif %}>Under Investigation</option>
                            <option value="Mediation Scheduled" {% if request.GET.status == 'Mediation Scheduled' %}selected{% endif %}>Mediation Scheduled</option>
                            <option value="Resolved" {% if request.GET.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                        </select>
                    </div>
                    <button type="submit" class="filter-btn">Apply Filters</button>
                </form>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-responsive">
                    {% if reports %}
                    <table>
                        <thead>
                            <tr>
                                <th>Report ID</th>
                                <th>Resident</th>
                                <th>Incident Type</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td><strong>{{ report.report_id }}</strong></td>
                                <td>{{ report.user.full_name }}</td>
                                <td>{{ report.incident_type }}</td>
                                <td>{{ report.place|truncatewords:5 }}</td>
                                <td><span class="status-badge status-{{ report.status|lower|cut:' ' }}">{{ report.status }}</span></td>
                                <td>{{ report.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <button type="button" class="action-btn btn-view" onclick="viewReport(this)" data-report-id="{{ report.report_id }}" data-resident-name="{{ report.user.full_name|escapejs }}" data-incident-type="{{ report.incident_type|escapejs }}" data-location="{{ report.place|escapejs }}" data-message="{{ report.message|escapejs }}" data-status="{{ report.status|escapejs }}" data-date="{{ report.created_at|date:'M d, Y H:i' }}">üëÅ View</button>
                                    <button onclick="openStatusModal('{{ report.report_id }}', '{{ report.status }}')" class="action-btn btn-update">‚úè Update</button>
                                    <button onclick="confirmDelete('{{ report.report_id }}')" class="action-btn btn-delete">üóë Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <i>üìã</i>
                        <h3>No Incident Reports Found</h3>
                        <p>There are no incident reports matching your filters.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <!-- View Report Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Report Details</h2>
            </div>
            <div class="modal-body" id="reportDetails">
                <!-- Will be filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeViewModal()" class="modal-btn modal-btn-cancel">Close</button>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Report Status</h2>
            </div>
            <form method="POST" id="statusForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="status_select">Report Status</label>
                        <select id="status_select" name="status" required>
                            <option value="Pending">Pending</option>
                            <option value="Under Investigation">Under Investigation</option>
                            <option value="Mediation Scheduled">Mediation Scheduled</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeStatusModal()" class="modal-btn modal-btn-cancel">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this report? This action cannot be undone.</p>
            </div>
            <form method="POST" id="deleteForm">
                {% csrf_token %}
                <div class="modal-footer">
                    <button type="button" onclick="closeDeleteModal()" class="modal-btn modal-btn-cancel">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-danger">Delete Report</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function viewReport(btn) {
            const modal = document.getElementById('viewModal');
            const details = document.getElementById('reportDetails');
            
            // Get data from button's data attributes
            const id = btn.dataset.reportId;
            const name = btn.dataset.residentName;
            const type = btn.dataset.incidentType;
            const place = btn.dataset.location;
            const message = btn.dataset.message;
            const status = btn.dataset.status;
            const date = btn.dataset.date;
            
            const statusClass = status.toLowerCase().replace(/ /g, '');
            
            details.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Report ID</div>
                    <div class="detail-value">${id}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Resident Name</div>
                    <div class="detail-value">${name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Incident Type</div>
                    <div class="detail-value">${type}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${place}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="status-badge status-${statusClass}">${status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Reported On</div>
                    <div class="detail-value">${date}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">${message}</div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        function openStatusModal(reportId, currentStatus) {
            const modal = document.getElementById('statusModal');
            const form = document.getElementById('statusForm');
            const select = document.getElementById('status_select');
            
            form.action = `/administration/reports/${reportId}/update-status/`;
            select.value = currentStatus;
            modal.classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.remove('active');
        }

        function confirmDelete(reportId) {
            const modal = document.getElementById('deleteModal');
            const form = document.getElementById('deleteForm');
            
            form.action = `/administration/reports/${reportId}/delete/`;
            modal.classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const statusModal = document.getElementById('statusModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == viewModal) {
                closeViewModal();
            }
            if (event.target == statusModal) {
                closeStatusModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>
</body>
</html>