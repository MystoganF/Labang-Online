{% extends 'base.html' %}
{% load static %}

{% block title %}Create your account • Labang Online{% endblock %}

{% block content %}
  <section class="panel">
    <div class="header">
      <h1>Create your account</h1>
    </div>
    <div class="body">
      <div class="messages">
        {% for field in form %}
          {% for error in field.errors %}
            <div class="msg error">{{ field.label }}: {{ error }}</div>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <div class="msg error">{{ error }}</div>
        {% endfor %}
        {% for message in messages %}
          <div class="msg {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="grid grid-2">
          <div>
            <label>Full name <span style="color: var(--danger);">*</span></label>
            <input name="full_name" id="full_name" value="{{ form.full_name.value|default:'' }}" required />
          </div>
          <div>
            <label>Username <span style="color: var(--danger);">*</span></label>
            <input name="username" id="username" value="{{ form.username.value|default:'' }}" required />
          </div>
          <div>
            <label>Email <span style="color: var(--danger);">*</span></label>
            <input type="email" name="email" id="email" value="{{ form.email.value|default:'' }}" required />
            <div class="hint">We will send a 6‑digit code</div>
          </div>
          <div>
            <label>Phone <span style="color: var(--danger);">*</span></label>
            <input name="contact_number" id="contact_number" value="{{ form.contact_number.value|default:'' }}" required />
            <div class="hint">Include country code (e.g., +63…)</div>
          </div>
          <div>
            <label>Date of birth <span style="color: var(--danger);">*</span></label>
            <input type="date" name="date_of_birth" id="date_of_birth" value="{{ form.date_of_birth.value }}" required />
          </div>
          <div>
            <label>Address line <span style="color: var(--danger);">*</span></label>
            <input name="address_line" id="address_line" value="{{ form.address_line.value|default:'' }}" required />
            <div class="hint">Street, house number, etc.</div>
          </div>
          <div>
            <label>Barangay</label>
            <input name="barangay" value="Labangon" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed;" />
          </div>
          <div>
            <label>City</label>
            <input name="city" value="Cebu City" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed;" />
          </div>
          <div>
            <label>Province</label>
            <input name="province" value="Cebu" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed;" />
          </div>
          <div>
            <label>Postal code</label>
            <input name="postal_code" value="6000" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed;" />
          </div>
          <div>
            <label>Password <span style="color: var(--danger);">*</span></label>
            <input type="password" name="password" id="password" required minlength="8" />
            <div class="hint">Minimum 8 characters</div>
          </div>
          <div>
            <label>Confirm password <span style="color: var(--danger);">*</span></label>
            <input type="password" name="password_confirm" id="password_confirm" required />
          </div>
        </div>

        <div class="upload-row">
          <label>NSO/PSA Birth Certificate or Valid ID <span style="color: var(--danger);">*</span></label>
          <input type="file" name="nso_document" id="nso_document" accept="image/*,.pdf" required style="padding: 10px;" />
          <div class="hint">Upload a clear photo of your NSO/PSA Birth Certificate or valid ID showing your Labangon address for verification. <strong>This field is required.</strong></div>
        </div>

        <div class="terms-box">
          <div class="terms-text-box">
            <p class="terms-text">
              This service is exclusively for verified residents of Barangay Labangon, Cebu City. By registering, you confirm that you are a current resident of Labangon.
            </p>
            <label class="terms-agree">
              <input type="checkbox" name="resident_confirmation" required />
              <span>I confirm</span>
            </label>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit" id="submit-btn">Create account</button>
        </div>
      </form>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  // Comprehensive form validation before submission
  document.querySelector('form').addEventListener('submit', function(e) {
    const requiredFields = [
      { id: 'full_name', label: 'Full name' },
      { id: 'username', label: 'Username' },
      { id: 'email', label: 'Email' },
      { id: 'contact_number', label: 'Phone' },
      { id: 'date_of_birth', label: 'Date of birth' },
      { id: 'address_line', label: 'Address line' },
      { id: 'password', label: 'Password' },
      { id: 'password_confirm', label: 'Confirm password' }
    ];
    
    // Check all required text fields
    for (let field of requiredFields) {
      const input = document.getElementById(field.id);
      if (!input.value.trim()) {
        e.preventDefault();
        alert(`${field.label} is required. Please fill in all required fields marked with *.`);
        input.focus();
        return false;
      }
    }
    
    // Validate email format
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      e.preventDefault();
      alert('Please enter a valid email address.');
      document.getElementById('email').focus();
      return false;
    }
    
    // Validate phone format (must start with +)
    const phone = document.getElementById('contact_number').value;
    if (!phone.startsWith('+')) {
      e.preventDefault();
      alert('Phone number must include country code (e.g., +63...)');
      document.getElementById('contact_number').focus();
      return false;
    }
    
    // Validate password length
    const password = document.getElementById('password').value;
    if (password.length < 8) {
      e.preventDefault();
      alert('Password must be at least 8 characters long.');
      document.getElementById('password').focus();
      return false;
    }
    
    // Validate password match
    const passwordConfirm = document.getElementById('password_confirm').value;
    if (password !== passwordConfirm) {
      e.preventDefault();
      alert('Passwords do not match. Please make sure both password fields are identical.');
      document.getElementById('password_confirm').focus();
      return false;
    }
    
    // Validate file upload
    const fileInput = document.getElementById('nso_document');
    if (!fileInput.files || fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please upload your NSO/PSA Birth Certificate or valid ID to proceed.');
      fileInput.focus();
      return false;
    }
    
    // Check file size (max 10MB)
    const maxSize = 10 * 1024 * 1024;
    if (fileInput.files[0].size > maxSize) {
      e.preventDefault();
      alert('File size must be less than 10MB. Please upload a smaller file.');
      fileInput.value = '';
      return false;
    }
    
    // Validate file type
    const file = fileInput.files[0];
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
      e.preventDefault();
      alert('Only JPEG, PNG, or PDF files are allowed for the document upload.');
      fileInput.value = '';
      return false;
    }
    
    // Validate resident confirmation
    const residentCheck = document.querySelector('input[name="resident_confirmation"]');
    if (!residentCheck.checked) {
      e.preventDefault();
      alert('Please confirm that you are a resident of Barangay Labangon.');
      residentCheck.focus();
      return false;
    }
    
    // Validate age (must be at least 13 years old)
    const dob = new Date(document.getElementById('date_of_birth').value);
    const today = new Date();
    const age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    const actualAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate()) ? age - 1 : age;
    
    if (actualAge < 13) {
      e.preventDefault();
      alert('You must be at least 13 years old to register.');
      document.getElementById('date_of_birth').focus();
      return false;
    }
  });
</script>
{% endblock %}