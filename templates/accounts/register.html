{% extends 'base.html' %}
{% load static %}
{% block title %}Create your account â€¢ Labang Online{% endblock %}

{% block content %}
<section class="panel">
  <div class="header">
    <h1>Create your account</h1>
  </div>
  <div class="body">
    <div class="messages">
      {% for field in form %}
        {% for error in field.errors %}
          <div class="msg error">{{ field.label }}: {{ error }}</div>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <div class="msg error">{{ error }}</div>
      {% endfor %}
      {% for message in messages %}
        <div class="msg {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="grid grid-2">
        <!-- User information fields -->
        <div>
          <label>Full name <span style="color: var(--danger)">*</span></label>
          <input name="full_name" id="full_name" value="{{ form.full_name.value|default:'' }}" placeholder="Juan Dela Cruz" required />
        </div>
        <div>
          <label>Username <span style="color: var(--danger)">*</span></label>
          <input name="username" id="username" value="{{ form.username.value|default:'' }}" placeholder="juandelacruz" required />
        </div>
        <div>
          <label>Email <span style="color: var(--danger)">*</span></label>
          <input type="email" name="email" id="email" value="{{ form.email.value|default:'' }}" placeholder="juan.delacruz@email.com" required />
          <div class="hint">We will send a 6â€‘digit code</div>
        </div>
        <div>
          <label>Phone <span style="color: var(--danger)">*</span></label>
          <input name="contact_number" id="contact_number" value="{{ form.contact_number.value|default:'+63' }}" placeholder="+639171234567" required minlength="13" maxlength="13" />
          <div class="hint">Philippine mobile number (13 digits including +63)</div>
        </div>
        <div>
          <label>Date of birth <span style="color: var(--danger)">*</span></label>
          <input type="date" name="date_of_birth" id="date_of_birth" value="{{ form.date_of_birth.value }}" required />
        </div>
        <div>
          <label>Address line <span style="color: var(--danger)">*</span></label>
          <input name="address_line" id="address_line" value="{{ form.address_line.value|default:'' }}" placeholder="123 Mabuhay Street, Purok 5" required />
          <div class="hint">Street, house number, etc.</div>
        </div>

        <!-- Fixed fields -->
        <div>
          <label>Barangay</label>
          <input name="barangay" value="Labangon" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed" />
        </div>
        <div>
          <label>City</label>
          <input name="city" value="Cebu City" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed" />
        </div>
        <div>
          <label>Province</label>
          <input name="province" value="Cebu" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed" />
        </div>
        <div>
          <label>Postal code</label>
          <input name="postal_code" value="6000" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed" />
        </div>
        <div>
          <label>Password <span style="color: var(--danger)">*</span></label>
          <input type="password" name="password" id="password" placeholder="Enter at least 8 characters" required minlength="8" />
          <div class="hint">Minimum 8 characters</div>
        </div>
        <div>
          <label>Confirm password <span style="color: var(--danger)">*</span></label>
          <input type="password" name="password_confirm" id="password_confirm" placeholder="Re-enter your password" required />
        </div>
      </div>

      <div class="info-box">
        <h1>ðŸ“‹ Account Verification Required</h1>
        <p>
          <strong>Important:</strong> Your account will be created with a <em>pending</em> status upon registration.
        </p>
        <p>
          To activate your account and gain access to the system, you must complete the following verification process:
        </p>
        <ol style="margin: 1rem 0; padding-left: 1.5rem;">
          <li>Visit the <strong>Barangay Hall of Labangon</strong> during office hours</li>
          <li>Present any of the following valid documents:
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              <li>Government-issued ID (e.g., Philippine National ID, Driver's License, Passport)</li>
              <li>NSO/PSA Birth Certificate</li>
            </ul>
          </li>
          <li>Our staff will verify your identity and activate your account</li>
        </ol>
        <p>
          <strong>Note:</strong> You will not be able to log in until your account has been verified and approved by barangay staff.
        </p>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit" id="submit-btn">
          Create account
        </button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Auto-fill +63 on focus if empty
  document.getElementById("contact_number").addEventListener("focus", function() {
    if (this.value === "" || this.value === "+63") {
      this.value = "+63";
    }
  });

  // Prevent deletion of +63 prefix
  document.getElementById("contact_number").addEventListener("keydown", function(e) {
    const cursorPosition = this.selectionStart;
    const value = this.value;
    
    // Prevent backspace or delete if it would remove part of +63
    if ((e.key === "Backspace" || e.key === "Delete") && cursorPosition <= 3) {
      e.preventDefault();
    }
  });

  // Ensure +63 stays at the beginning
  document.getElementById("contact_number").addEventListener("input", function() {
    if (!this.value.startsWith("+63")) {
      this.value = "+63" + this.value.replace(/^\+?6?3?/, "");
    }
  });

  document.querySelector("form").addEventListener("submit", function (e) {
    const requiredFields = [
      { id: "full_name", label: "Full name" },
      { id: "username", label: "Username" },
      { id: "email", label: "Email" },
      { id: "contact_number", label: "Phone" },
      { id: "date_of_birth", label: "Date of birth" },
      { id: "address_line", label: "Address line" },
      { id: "password", label: "Password" },
      { id: "password_confirm", label: "Confirm password" },
    ];

    for (let field of requiredFields) {
      const input = document.getElementById(field.id);
      if (!input.value.trim()) {
        e.preventDefault();
        alert(`${field.label} is required. Please fill in all required fields marked with *.`);
        input.focus();
        return false;
      }
    }

    // Validate email
    const email = document.getElementById("email").value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      e.preventDefault();
      alert("Please enter a valid email address.");
      document.getElementById("email").focus();
      return false;
    }

    // Validate phone
    const phone = document.getElementById("contact_number").value;
    if (!phone.startsWith("+63")) {
      e.preventDefault();
      alert("Phone number must start with +63 (Philippine country code)");
      document.getElementById("contact_number").focus();
      return false;
    }
    
    if (phone.length !== 13) {
      e.preventDefault();
      alert("Phone number must be exactly 13 characters (+63 followed by 10 digits, e.g., +639171234567)");
      document.getElementById("contact_number").focus();
      return false;
    }
    
    // Check if all characters after +63 are digits
    const phoneDigits = phone.substring(3);
    if (!/^\d{10}$/.test(phoneDigits)) {
      e.preventDefault();
      alert("Phone number must contain only digits after +63");
      document.getElementById("contact_number").focus();
      return false;
    }

    // Validate address line
    const addressLine = document.getElementById("address_line").value.trim();
    if (addressLine.length < 10) {
      e.preventDefault();
      alert("Address line is too short. Please provide a complete address (at least 10 characters).");
      document.getElementById("address_line").focus();
      return false;
    }
    
    // Check if address contains at least some letters and numbers (basic street address pattern)
    const hasLetters = /[a-zA-Z]/.test(addressLine);
    const hasNumbers = /\d/.test(addressLine);
    if (!hasLetters) {
      e.preventDefault();
      alert("Address line must contain street or location name.");
      document.getElementById("address_line").focus();
      return false;
    }
    
    // Check for suspicious patterns (all numbers, all special characters, etc.)
    const validAddressPattern = /^[a-zA-Z0-9\s,.\-#\/]+$/;
    if (!validAddressPattern.test(addressLine)) {
      e.preventDefault();
      alert("Address line contains invalid characters. Please use only letters, numbers, spaces, and common punctuation (,.-#/).");
      document.getElementById("address_line").focus();
      return false;
    }

    // Validate password length
    const password = document.getElementById("password").value;
    if (password.length < 8) {
      e.preventDefault();
      alert("Password must be at least 8 characters long.");
      document.getElementById("password").focus();
      return false;
    }

    // Validate password match
    const passwordConfirm = document.getElementById("password_confirm").value;
    if (password !== passwordConfirm) {
      e.preventDefault();
      alert("Passwords do not match. Please make sure both password fields are identical.");
      document.getElementById("password_confirm").focus();
      return false;
    }

    // Validate age
    const dob = new Date(document.getElementById("date_of_birth").value);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) age--;
    if (age < 13) {
      e.preventDefault();
      alert("You must be at least 13 years old to register.");
      document.getElementById("date_of_birth").focus();
      return false;
    }
  });
</script>
{% endblock %}