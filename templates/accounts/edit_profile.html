{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Edit Profile - LabangOnline{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/edit_profile.css' %}" />
{% endblock %}

{% block content %}
<!-- Left Column: User Information -->
<div class="content-left">
  <div class="user-header">
    {% if user.profile_photo_url %}
    <img src="{{ user.profile_photo_url }}" alt="User Profile" />
    {% else %}
    <img src="{% static 'icons/default_user.png' %}" alt="User Profile" />
    {% endif %}
    <div class="user-name">
      <h2>{{ user.full_name|default:"User" }}</h2>
      <span class="role {% if not user.resident_confirmation %}pending{% endif %}">
        {% if user.resident_confirmation %}Resident{% else %}Pending Verification{% endif %}
      </span>
    </div>
  </div>

  {% if messages %}
  <div class="messages" style="margin-bottom: 20px;">
    {% for message in messages %}
    <div class="msg {% if message.tags %}{{ message.tags }}{% endif %}" 
         style="padding: 12px 16px; border-radius: 8px; margin-bottom: 10px;
                {% if message.tags == 'error' %}background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);{% endif %}
                {% if message.tags == 'success' %}background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3);{% endif %}
                {% if message.tags == 'warning' %}background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- PROFILE PHOTO UPLOAD FORM -->
  <form method="post" action="{% url 'accounts:update_profile_photo' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="info-section">
      <h3>PROFILE PHOTO</h3>
      <table class="user-info-table">
        <tr>
          <td>Current Photo:</td>
          <td>
            {% if user.profile_photo_url %}
            <img src="{{ user.profile_photo_url }}" alt="Current Profile" style="max-width: 150px; border-radius: 8px;" />
            {% else %}
            <span style="color: var(--text-secondary);">No photo uploaded</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>New Photo:</td>
          <td>
            <input type="file" name="profile_photo" accept="image/*" id="profile-photo-input" required />
            <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
              JPG, PNG, or GIF. Max 5MB.
            </small>
          </td>
        </tr>
      </table>
      <div class="btn-row">
        <button type="submit" class="btn-primary">Update Profile Photo</button>
      </div>
    </div>
  </form>

  <!-- RESIDENT ID UPLOAD FORM -->
  <form method="post" action="{% url 'accounts:update_resident_id' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="info-section">
      <h3>RESIDENT ID</h3>
      <table class="user-info-table">
        <tr>
          <td>Current ID:</td>
          <td>
            {% if user.resident_id_photo_url %}
            <img src="{{ user.resident_id_photo_url }}" alt="Current Resident ID" style="max-width: 300px; border-radius: 8px;" />
            {% else %}
            <span style="color: var(--text-secondary);">No ID uploaded</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>New ID Photo:</td>
          <td>
            <input type="file" name="resident_id_photo" accept="image/*" id="resident-id-input" required />
            <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
              Clear photo of your valid Resident ID. JPG or PNG.
            </small>
          </td>
        </tr>
      </table>
      <div class="btn-row">
        <button type="submit" class="btn-primary">Update Resident ID</button>
      </div>
    </div>
  </form>

  <!-- BASIC INFO UPDATE FORM -->
  <form method="post" action="{% url 'accounts:update_basic_info' %}">
    {% csrf_token %}
    <div class="info-section">
      <h3>USER INFORMATION</h3>
      <table class="user-info-table">
        <tr>
          <td>Full Name:</td>
          <td><input type="text" name="full_name" value="{{ user.full_name }}" required /></td>
        </tr>
        <tr>
          <td>Username:</td>
          <td><input type="text" name="username" value="{{ user.username }}" required /></td>
        </tr>
        <tr>
          <td>Email:</td>
          <td><input type="email" name="email" value="{{ user.email }}" required /></td>
        </tr>
        <tr>
          <td>Date of Birth:</td>
          <td><input type="date" name="date_of_birth" value="{{ user.date_of_birth|date:'Y-m-d' }}" /></td>
        </tr>
        <tr>
          <td>Civil Status:</td>
          <td>
            <select name="civil_status">
              <option value="">Select status</option>
              <option value="Single" {% if user.civil_status == "Single" %}selected{% endif %}>Single</option>
              <option value="Married" {% if user.civil_status == "Married" %}selected{% endif %}>Married</option>
              <option value="Widowed" {% if user.civil_status == "Widowed" %}selected{% endif %}>Widowed</option>
              <option value="Separated" {% if user.civil_status == "Separated" %}selected{% endif %}>Separated</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Address:</td>
          <td>
            <div class="two-col" style="margin-bottom:12px;">
              <input type="text" name="address_line" placeholder="Street Address" value="{{ user.address_line }}" required />
              <input type="tel" name="contact_number" placeholder="e.g., +639171234567" value="{{ user.contact_number }}" required pattern="^\+63[0-9]{10}$" title="Phone number must start with +63 followed by 10 digits" />
            </div>
            <div class="two-col">
              <input type="text" name="barangay" placeholder="Barangay" value="{{ user.barangay|default:'Labangon' }}" disabled />
              <input type="text" name="city" placeholder="City" value="{{ user.city|default:'Cebu City' }}" disabled />
            </div>
            <div class="two-col" style="margin-top:12px;">
              <input type="text" name="province" placeholder="Province" value="{{ user.province|default:'Cebu' }}" disabled />
              <input type="text" name="postal_code" placeholder="Postal Code" value="{{ user.postal_code|default:'6000' }}" disabled />
            </div>
          </td>
        </tr>
        <tr>
          <td>Resident Confirmed:</td>
          <td>
            {% if user.resident_confirmation %}
            <span style="color: #10b981; font-weight: 600;">✓ Yes</span>
            {% else %}
            <span style="color: var(--text-secondary); font-weight: 600;">⏳ No</span>
            {% endif %}
          </td>
        </tr>
      </table>

      <div class="btn-row">
        <a href="{% url 'accounts:personal_info' %}" class="btn-secondary">Cancel</a>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-format phone number with +63 prefix
  const phoneInput = document.querySelector('input[name="contact_number"]');
  
  if (phoneInput) {
    // Format on input
    phoneInput.addEventListener('input', function(e) {
      let value = e.target.value;
      
      // Remove all non-digit characters except +
      value = value.replace(/[^\d+]/g, '');
      
      // If user is typing and doesn't have +63, add it
      if (!value.startsWith('+63')) {
        // If starts with 0, replace with +63
        if (value.startsWith('0')) {
          value = '+63' + value.substring(1);
        }
        // If starts with 63, add +
        else if (value.startsWith('63')) {
          value = '+' + value;
        }
        // If starts with +, keep it and ensure 63 follows
        else if (value.startsWith('+')) {
          if (!value.startsWith('+63')) {
            value = '+63' + value.substring(1);
          }
        }
        // Otherwise add +63 prefix
        else if (value.length > 0) {
          value = '+63' + value;
        }
      }
      
      // Limit to +63 + 10 digits
      if (value.length > 13) {
        value = value.substring(0, 13);
      }
      
      e.target.value = value;
    });
    
    // Ensure +63 on focus if empty
    phoneInput.addEventListener('focus', function(e) {
      if (!e.target.value) {
        e.target.value = '+63';
      }
    });
    
    // Validate on blur
    phoneInput.addEventListener('blur', function(e) {
      const value = e.target.value;
      if (value && value !== '+63') {
        if (value.length !== 13 || !value.startsWith('+63')) {
          alert('Please enter a valid Philippine mobile number (e.g., +639171234567)');
        }
      }
    });
  }

  // Preview selected images before upload
  document.getElementById('profile-photo-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      console.log('Profile photo selected:', file.name);
      // Optional: Add preview functionality here
    }
  });

  document.getElementById('resident-id-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      console.log('Resident ID selected:', file.name);
      // Optional: Add preview functionality here
    }
  });
</script>
{% endblock %}